---

copyright:
  years: 2016, 2017
lastupdated: "2017-05-15"
---

{:new_window: target="\_blank"}
{:shortdesc: .shortdesc}
{:screen:.screen}
{:codeblock:.codeblock}
{:pre: .pre}

# 証明書の構成
{: #set_up_certificates}

証明書は、デバイス認証に使用したり、MQTT メッセージング用の {{site.data.keyword.iot_full}} のデフォルトのサーバー証明書を置き換えるために使用したりします。署名付きの有効な証明書のないデバイスは、アクセスを拒否され、サーバーと通信できません。

デバイスの証明書やサーバーへのアクセスを構成するには、システム・オペレーターが、関連する認証局 (CA) 証明書とオプションでメッセージ・サーバー証明書を {{site.data.keyword.iot_short_notm}} プラットフォームに登録します。

API を使用して CA 証明書とメッセージング・サーバー証明書を管理する方法については、[IBM Watson IoT Platform Authentication and Authorization APIs ![外部リンク・アイコン](../../../../icons/launch-glyph.svg)"外部リンク・アイコン")](https://docs.internetofthings.ibmcloud.com/apis/swagger/v0002/security.html){: new_window} を参照してください。

## CA 証明書
CA 証明書を使用すると、組織は、デバイス上のクライアント証明書を信頼されたものとして認識できるので、デバイスをサーバーに接続できます。

CA 証明書を追加したり、メッセージング・サーバー証明書を置き換えたりする場合は、サーバーが適切な CA を使用してデバイスを認証できるように、すべてのデバイスが、サーバー名表示 (SNI) をサポートする MQTT クライアントを使用して接続している必要があります。

接続セキュリティー・ポリシーを構成することによって、接続セキュリティー・レベルを設定できます。これを行う方法については、[セキュリティー・ポリシーの構成](set_up_policies.html)を参照してください。

## クライアント証明書

個々のクライアント (デバイスまたはゲートウェイ) の証明書はデバイス上に残り、プラットフォームにはアップロードされません。すべてのデバイスとゲートウェイの証明書の署名に使用される CA 署名証明書は、プラットフォームにアップロードする唯一の証明書です。自己署名メッセージング・サーバー証明書を使用する場合は、クライアント証明書 (cert.pem) の署名に使用するルート証明書と中間証明書をアップロードする必要があります。

CA 証明書を使用して署名する個々のデバイスまたはゲートウェイの証明書には、デバイス ID またはゲートウェイ ID が共通名 (CN) または SubjectAltName として証明書に入力されている必要があります。

デバイスの場合、**CN** フィールドの形式は「`CN=d:devtype:devid`」で、**SubjectAltName** フィールドの形式は「`SubjectAltName=email:d:*devtype:devid*`」です。「`email:d`」は定数、「`*devtype*`」はデバイスのデバイス・タイプ、「`*devid*`」はプラットフォームのデバイスの ID です。

ゲートウェイの場合、**CN** フィールドの形式は「`CN=g:typeId:deviceId`」で、**SubjectAltName** フィールドの形式は「SubjectAltName=email:g: *devtype:devid*」です。

注: デバイスまたはゲートウェイの証明書の **CN** または **SubjectAltName** フィールドに、「`orgId`」を含めないでください。「`orgId`」は、メッセージング・サーバーへの接続時に、クライアント実装により提供される SNI 情報の一部として指定される必要があります。

クライアント証明書について詳しくは、[the Connect Raspberry Pi to IBM Watson IoT Platform using Client side Certificates recipe ![外部リンク・アイコン](../../../../icons/launch-glyph.svg) "外部リンク・アイコン")](https://developer.ibm.com/recipes/tutorials/connect-raspberry-pi-to-ibm-watson-iot-platform-using-client-side-certificates/){: new_window} を参照してください。

## メッセージング・サーバー証明書

メッセージング・サーバー証明書は、デフォルトのドメインである internetofthings.ibmcloud.com を受け入れます。証明書の CN または SubjectAltName は、以下の形式に従っている必要があります。

- `orgId.messaging.internetofthings.ibmcloud.com` (IoTP ドメイン)

以下の例は、サーバー証明書の有効な CN を示しています。

`mtxpd0.messaging.internetofthings.ibmcloud.com`

メッセージング・サーバー証明書について詳しくは、[the Connect Raspberry Pi to IBM Watson IoT Platform using Self-Signed Server Certificate recipe ![外部リンク・アイコン](../../../../icons/launch-glyph.svg) "外部リンク・アイコン")](https://developer.ibm.com/recipes/tutorials/connect-raspberry-pi-to-ibm-watson-iot-platform-using-selfsigned-server-certificate/){: new_window} を参照してください。

### カスタム・ドメイン (ベータ)
{: #custom_domains}

**重要**: メッセージング・サーバー証明書のカスタム・ドメイン機能は、限定されたベータ・プログラムの一部としてのみ使用できます。カスタム・ドメインを有効にするには、**「設定」**ページの**「試験機能」**をオンにします。

ベータ機能の一部として、メッセージング・サーバー証明書はカスタム・ドメインを受け入れます。証明書の CN または SubjectAltName は、以下の形式に従っている必要があります。

- `orgId.messaging<custom domain>`

**CN** フィールドは、以下の例に示すように、カスタム・ドメインについてワイルドカード文字を受け入れます。

- `CN=*.messaging.fab-iot.com`

**重要**: カスタム・ドメインの場合、カスタム・ドメインを {{site.data.keyword.iot_full}} メッセージング・サーバーに解決するために、外部 DNS サービスが必要になります。この DNS サービスは、プラットフォームによって提供されません。

## デバイス認証のための認証局 (CA) 証明書の登録
{: #reg_ca_cert}

1. {{site.data.keyword.iot_short_notm}} にログインし、**「一般設定」**にナビゲートします。
2. **「セキュリティー」**セクションの**「CA 証明書」**で**「証明書の追加」**をクリックします。
3. アップロードする証明書ファイルを参照して選択するか、**「証明書の追加」**ウィンドウにファイルをドラッグ・アンド・ドロップします。そのファイルは、証明書が 1 つだけ入っているファイルでなければならず、証明書の日付が有効でなければなりません。受け入れられる証明書の形式は、.pem または .der だけです。選択したファイルに入っている証明書の情報をプレビューすることもできます。
4. 証明書ファイルの説明を入力します。
5. 正しいファイルを選択したことを確認して、**「保存」**をクリックします。選択した証明書がテーブルにリストされ、デフォルトでアクティブになります。

## メッセージング・サーバー証明書の登録
{: #reg_msg_cert}

プラットフォームには、デフォルトのサーバー証明書が用意されています。デフォルトの証明書を使用することも、組織の証明書をアップロードすることもできます。使用する証明書がない場合は、新しい証明書の要求を作成できます。新しい証明書を受け取ったら、署名を付けてからプラットフォームにアップロードしなければなりません。

**注:** プラットフォームのダッシュボード・ページでは、デバイス情報を取得するためにメッセージング・サーバーへの内部接続が行われる場合があります。組織向けの自己署名サーバー証明書を設定する場合、ダッシュボード・ユーザーは、接続の問題を回避するために、信頼された証明書としてサーバー証明書をブラウザーに追加する必要があります。これは、デフォルトでは、ブラウザーで、メッセージング・サーバーが信頼されるサーバーとして認識されないためです。

## 組織のメッセージング・サーバー証明書のアップロード
{: #upload_cert}
1. **「一般設定」**の**「セキュリティー」**セクションにある**「メッセージング・サーバー証明書」**で**「証明書の追加」**をクリックします。
2. アップロードする証明書ファイルを参照して選択するか、**「証明書の追加」**ウィンドウにファイルをドラッグ・アンド・ドロップします。
3. アップロードする秘密鍵ファイルを参照して選択するか、**「証明書の追加」**ウィンドウにファイルをドラッグ・アンド・ドロップします。
4. 秘密鍵がパスフレーズで暗号化されている場合は、そのパスフレーズを入力します。
5. 正しいファイルを選択したことを確認して、**「保存」**をクリックします。

## メッセージング・サーバー証明書のアクティブ化

デフォルトの証明書または既にアップロードした別の証明書をアクティブ化するには、**「メッセージング・サーバー証明書」**の下にあるテーブルの**「デフォルトのメッセージング・サーバー証明書」**ドロップダウン・リストから、使用する証明書を選択します。選択した証明書がアクティブな証明書としてテーブルにリストされます。

## 新しいメッセージング・サーバー証明書の要求
{: #request_cert}

新しいメッセージング・サーバー証明書を使用する場合は、証明書署名要求 (CSR) を生成して新しい証明書を要求できます。

1. **「一般設定」**の**「セキュリティー」**セクションにある**「メッセージング・サーバー証明書」**で**「CSR の生成」**をクリックします。
2. サーバーに対して CSR を要求するための詳細情報を入力して、**「生成」**をクリックします。CSR がテーブルに表示されます。
3. 要求をダウンロードして、署名を得るために認証局に送信します。
4. 証明書を取得したら、テーブルの CSR エントリーに戻り、新しい証明書をアップロードします。証明書をアップロードすると、テーブル内の CSR が、アップロードした証明書に置き換わります。
