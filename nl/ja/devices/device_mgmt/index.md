---

copyright:
  years: 2015, 2018
lastupdated: "2018-03-08"

---

{:new_window: target="\_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:codeblock: .codeblock}
{:pre: .pre}


# デバイス管理プロトコル
{: #index}

## 概要
{: #introduction}

{{site.data.keyword.iot_full}} は、デバイスとゲートウェイをデバイスの 2 つのクラスとして認識します。デバイス・クラスは、「classId」フィールドを使用して識別されます。デバイス・クラスのデバイスは、管理対象デバイスまたは非管理対象デバイスにすることができます。

**管理対象デバイス**とは、デバイス管理エージェントが組み込まれたデバイスとして定義されます。 デバイス管理エージェントとは、デバイスがデバイス管理プロトコルを使用して {{site.data.keyword.iot_short_notm}} デバイス管理サービスと対話するための一連のロジックのことです。 管理対象デバイスは、デバイス管理操作 (場所の更新、ファームウェアのダウンロードと更新、リブート、工場出荷時設定へのリセットなど) を実行できます。

デバイス管理プロトコルとは、サポートされる操作のセットを定義したものです。 デバイス管理エージェントは操作のサブセットをサポートできますが、「デバイスを管理」要求を作成する必要があります。ファームウェア・アクション操作をサポートするデバイスは、監視もサポートする必要があります。

デバイス管理プロトコルは、MQTT メッセージング・プロトコル上に構築されています。 デバイス管理プロトコルが MQTT とどのように対話するかについての詳細は、[デバイスの MQTT 接続](../mqtt.html)を参照してください。


### デバイス管理ライフサイクル

1. デバイスとそれに関連したデバイス・タイプが、ダッシュボードまたは REST API のどちらかを使用して、{{site.data.keyword.iot_short_notm}} に作成されます。
2. デバイスは {{site.data.keyword.iot_short_notm}} に接続して「デバイスを管理」要求を作成し、管理対象デバイスになります。
3. {{site.data.keyword.iot_short_notm}} REST API を使用することにより、デバイスのメタデータを表示して操作できます。 これらの API 操作 (例えば、ファームウェア更新操作やデバイス再始動操作) の概要説明が、[デバイス管理要求](https://console.ng.bluemix.net/docs/services/IoT/devices/device_mgmt/requests.html)の資料にあります。
4. デバイスはそのロケーション、診断情報、エラー・コードに関する更新を、デバイス管理プロトコルを使用して通信できます。
5. 廃止されたデバイスは、ダッシュボードまたは REST API を使用して {{site.data.keyword.iot_short_notm}} から削除できます。

レシピ [Connect Raspberry Pi as Managed Device to IBM Watson IoT Platform ![外部リンク・アイコン](../../../../icons/launch-glyph.svg "外部リンク・アイコン")](https://developer.ibm.com/recipes/tutorials/connect-raspberry-pi-as-managed-device-to-ibm-iot-foundation/){: new_window} を参照してください。

## 「デバイスを管理」要求
{: #manage_device_request}

デバイスは「デバイスを管理」要求を使用して管理対象デバイスになります。 デバイス管理エージェントがサーバーから要求を受信するには、「デバイスを管理」要求を送信する必要があります。デバイス管理エージェントは通常、開始または再始動するときは必ず、このタイプの要求を送信します。

### 「デバイスを管理」要求のトピック

デバイスは、「デバイスを管理」要求を次のトピックにパブリッシュします。

```
iotdevice-1/mgmt/manage
```

サーバーは、次のトピックで「デバイスを管理」要求に応答します。

```
iotdm-1/response
```




### 「デバイスを管理」要求のメッセージ形式


「デバイスを管理」要求では、``d`` フィールドとそのサブフィールドすべてがオプションです。 ``metadata`` フィールド値と ``deviceInfo`` フィールド値が送信されると、送信デバイスの対応する属性と置き換わります。

オプションの ``lifetime`` フィールドは、デバイス次回の「デバイスを管理」要求を送信するまでの制限時間 (秒数) です。これを過ぎると、デバイスは休止として分類されて非管理対象デバイスになります。 ``lifetime`` フィールドが省略された場合、または ``0`` に設定された場合、管理対象デバイスは休止になりません。 ``lifetime`` フィールドのサポートされる最小の設定値は ``3600`` 秒 (1 時間) です。

オプションの ``supports.deviceActions`` フィールドと ``supports.firmwareActions`` フィールドは、デバイス管理エージェントの機能を示します。 ``supports.deviceActions`` が設定された場合、エージェントは再始動と工場出荷時設定へのリセットの両方のアクションをサポートします。 再始動と工場出荷時設定へのリセットを区別しないデバイスの場合は、両方のアクションに同じ動作を使用することができます。 ``supports.firmwareActions`` が設定された場合、エージェントはファームウェア・ダウンロードとファームウェア更新の両方のアクションをサポートします。

次のサンプルは、要求の形式を示しています。

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/mgmt/manage
{
    "d": {
        "metadata":{},
        "lifetime": number,
        "supports": {
            "deviceActions": boolean,
            "firmwareActions": boolean
        },
        "deviceInfo": {
            "serialNumber": "string",
            "manufacturer": "string",
            "model": "string",
            "deviceClass": "string",
            "description" :"string",
            "fwVersion": "string",
            "hwVersion": "string",
            "descriptiveLocation": "string"
        }
    },
    "reqId": "string"
}
```

次のサンプルは、応答の形式を示しています。

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```


### 「デバイスを管理」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|403   |禁止 (デバイスが一連の無効なアクションのサポートを要求する管理要求をパブリッシュしようとした場合)|
|404   |デバイスが {{site.data.keyword.iot_short_notm}}  に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|


## 「デバイスを管理解除」要求
{: #manage-unmanage}


デバイスは、管理される必要がなくなったときに、「デバイスを管理解除」要求を使用します。 デバイスが非管理対象になると、{{site.data.keyword.iot_short_notm}} は新しいデバイス管理要求をそのデバイスに送信しなくなります。 非管理対象デバイスは、引き続きエラー・コード、ログ・メッセージ、ロケーション・メッセージをパブリッシュできます。

### 「デバイスを管理解除」要求のトピック


デバイスは、「デバイスを管理解除」要求を次のトピックにパブリッシュします。

```
iotdevice-1/mgmt/unmanage
```

サーバーは、次のトピックで「デバイスを管理解除」要求に応答します。

```
iotdm-1/response
```

### 「デバイスを管理解除」要求のメッセージ形式

要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/mgmt/unmanage
{
    "reqId": "string"
}
```

応答の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```

### 「デバイスを管理解除」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|


## 「ロケーションを更新」要求
{: #update-location}

デバイスのロケーション・メタデータは、以下の方法で {{site.data.keyword.iot_short_notm}} で更新できます。

### デバイス・ロケーションの自動更新
- 自身のロケーションを判別できるデバイスは、ロケーションの変更を {{site.data.keyword.iot_short_notm}} デバイス管理サーバーに通知することを選択できます。 デバイスが {{site.data.keyword.iot_short_notm}} にロケーション更新を通知します。 デバイスは GPS レシーバーなどから自身のロケーションを取得して、ロケーションを更新するためのデバイス管理メッセージを {{site.data.keyword.iot_short_notm}} インスタンスに送信します。GPS レシーバーからロケーションが取得された時刻がタイム・スタンプに取り込まれます。 このタイム・スタンプは、ロケーション更新メッセージの送信に遅れがあっても有効です。 サーバーはメッセージの受信日時を記録し、その情報を使用して、タイム・スタンプが使用されなかった場合にロケーション・メタデータを更新します。

### REST API を使用したデバイス・ロケーションの手動更新
- {{site.data.keyword.iot_short_notm}} REST API を使用することにより、静的デバイスのロケーション・メタデータをそのデバイスの登録時に手動で設定できます。 後でロケーションを変更することもできます。 タイム・スタンプ設定はオプションですが、省略した場合は、現在の日時がデバイスのロケーション・メタデータに設定されます。

### デバイスによってトリガーされる「ロケーションを更新」要求のトピック:


デバイスは、「ロケーションを更新」要求を次のトピックにパブリッシュします。

```
iotdevice-1/device/update/location
```

サーバーは、次のトピックで「ロケーションを更新」要求に応答します。

```
iotdm-1/response
```

### ユーザーまたはアプリによってトリガーされるロケーション更新


アクティブな管理対象デバイスのロケーションをユーザーまたはアプリケーションが更新すると、そのデバイスは更新メッセージを受信します。




### ユーザーまたはアプリによってトリガーされる「ロケーションを更新」要求のトピック


サーバーは、「ロケーションを更新」要求を次のトピックにパブリッシュします。

```
iotdm-1/device/update
```

### 「ロケーションを更新」要求のメッセージ形式


``measuredDateTime`` フィールドはロケーション測定の日時です。

ロケーションが更新されるときは常に、緯度、経度、高度、正確度を示す値が、1 つの複数値更新と見なされます。緯度と経度は必須であり、更新ごとにこの両方を提供する必要があります。 World Geodetic System 1984 (WGS84) を使用して、緯度と経度を 10 進度数で指定する必要があります。 高度および正確度はメートルで測定され、オプションです。

ある更新でオプションの値を指定し、その後の更新では省略した場合、前の値は後の更新によって削除されます。 それぞれの更新は、複数値の完全セットと見なされます。


要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/device/update/location
{
    "d": {
        "longitude": number,
        "latitude": number,

        "elevation": number,
        "measuredDateTime": "string in ISO8601 format",
        "updatedDateTime": "string in ISO8601 format",
        "accuracy": number
    },
    "reqId": "string"
}
```

応答の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```

### 「ロケーションを更新」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|


### ユーザーまたはアプリによってトリガーされるロケーション更新


次のサンプルは、ペイロードの形式の概要を示しています。

```
サーバーからの着信メッセージ:

Topic: iotdm-1/device/update
{
    "d": {
        "fields": [
				{
                "field": "location",
                "value": {
                    "latitude": number,
                    "longitude": number,
                    "elevation": number,
                    "accuracy": number,
                    "measuredDateTime": "string in ISO8601 format"
                    "updatedDateTime": "string in ISO8601 format",

                }
            }
        ]
    }
}
```

**注:** ``reqID`` パラメーターが使用されていないのは、デバイスは応答する必要がないからです。

## 「デバイス属性を更新」要求
{: #update-attributes}

REST API を使用して、{{site.data.keyword.iot_short_notm}} は次のデバイス属性の 1 つ以上について、値を更新する要求をデバイスに送信できます。


|属性 | 詳細情報|
|:---|:---|
|location  | [ロケーションを更新](index.html#update-location)を参照|
|metadata  | オプション|
|deviceInfo | オプション|
|mgmt.firmware | [ファームウェア更新プロセス](requests.html#firmware-actions-update)を参照|

### 「デバイス属性を更新」要求のトピック


サーバーは、デバイス更新要求を次のトピックにパブリッシュします。

```
iotdm-1/device/update
```


### 「デバイス属性を更新」要求のメッセージ形式


次のサンプルは、要求のペイロードの形式の概要を示しています。

```
サーバーからの着信メッセージ:

Topic: iotdm-1/device/update
{
    "d": {
        "fields": [
				{
                "field": "location",
                "value": ""
            }
        ]
    }
}
```


## 「エラー・コードを追加」要求
{: #diag-add-error-code}

デバイスは、「エラー・コードを追加」要求タイプを使用して、自身のエラー状況の変更を {{site.data.keyword.iot_short_notm}} デバイス管理サーバーに通知することを選択できます。

### 「エラー・コードを追加」要求のトピック


デバイスは、「エラー・コードを追加」要求を次のトピックにパブリッシュします。

```
iotdevice-1/add/diag/errorCodes
```

### 「エラー・コードを追加」要求のメッセージ形式


`errorCode` に関連付けられた値は現在のデバイス・エラー・コードであり、{{site.data.keyword.iot_short_notm}} に追加されなければなりません。

要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/add/diag/errorCodes
{
    "d": {
        "errorCode": number
    },
    "reqId": "string"
}
```

応答の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```

### 「エラー・コードを追加」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|


## 「エラー・コードの消去」要求
{: #diag-clear-error-codes}

デバイスは、「エラー・コードの消去」要求タイプを使用して、デバイスのエラー・コードをすべてクリアするよう {{site.data.keyword.iot_short_notm}} に要求できます。

### 「エラー・コードの消去」要求のトピック


デバイスは、この要求を次のトピックにパブリッシュします。

```
iotdevice-1/clear/diag/errorCodes
```

### 「エラー・コードの消去」要求のメッセージ形式


要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/clear/diag/errorCodes
{
    "reqId": "string"
}
```

応答の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": 200,
    "reqId": "string"
}
```

### 「エラー・コードの消去」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|


## 「ログを追加」要求
{: #diag-add-log}

デバイスは、新しいログ・エントリーを追加することにより、変更を {{site.data.keyword.iot_short_notm}} デバイス管理サポートに通知するかどうかを選択できます。 ログ・エントリーには、ログ・メッセージ、タイム・スタンプ、重大度と、オプションの Base64 エンコード・バイナリー診断データが含まれます。

### 「ログを追加」要求のトピック
デバイスは、この要求を次のトピックにパブリッシュします。

```
iotdevice-1/add/diag/log
```


### 「ログを追加」要求のメッセージ形式

次の表は、出力メッセージの属性の形式を示しています。

|属性 |説明 |
|:---|:---|
|`message`|{{site.data.keyword.iot_short_notm}} に追加する必要がある診断メッセージを指定します|
|`timestamp`|ログ・エントリーの日時を ISO8601 形式で指定します |
|`data`|オプションの Base64 エンコード診断データを指定します|
|`severity`|メッセージの重大度を指定します (0: 通知、1: 警告、2: エラー)|


要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/add/diag/log
{
    "d": {
        "message": "string",
        "timestamp": "string",
        "data": "string",
        "severity": number
    },
    "reqId": "string"
}
```

応答の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```


### 「ログを追加」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|

## 「ログの消去」要求
{: #diag-clear-logs}

デバイスは、「ログの消去」要求タイプを使用して、デバイスのログ・エントリーをすべてクリアするよう {{site.data.keyword.iot_short_notm}} に要求できます。

### 「ログの消去」要求のトピック


デバイスは、「ログの消去」要求を次のトピックにパブリッシュします。

```
iotdevice-1/clear/diag/log
```

### 「ログの消去」要求のメッセージ形式


要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/clear/diag/log
{
    "reqId": "string"
}
```

応答の形式:

```
デバイスからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```

### 「ログの消去」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|

## 「属性変更の監視」要求
{: #observations-observe}

{{site.data.keyword.iot_short_notm}} は、「属性変更の監視」要求タイプを使用して、1 つ以上のデバイス属性の変更を監視するよう、属性変更の監視要求をデバイスに送信できます。 デバイスは要求を受信すると、監視対象属性の値が変わったときは必ず、{{site.data.keyword.iot_short_notm}} に通知要求を送信する必要があります。

**重要:** デバイスは、[ファームウェア・アクション - 更新](requests.html#firmware-actions-update)要求タイプをサポートするためには、監視操作、通知操作、取り消し操作を実装する必要があります。

### 「属性変更の監視」要求のトピック


サーバーは、「属性変更の監視」要求を次のトピックにパブリッシュします。

```
iotdm-1/observe
```

### 「属性変更の監視」要求のメッセージ形式


`fields` 配列は、デバイス・モデルのデバイス属性の配列です。 `mgmt.firmware` のような複合フィールドを指定する場合は、その基礎フィールドも同時に更新するようにしてください。そうすることで、通知メッセージが 1 つだけ生成されるようにします。

`rc` パラメーターの値が `200` でない場合は、応答で使用される `message` パラメーターを指定できます。 指定したパラメーター値を取得できない場合は、`rc` パラメーターの値が `404` (属性が見つからない場合)、または `500` (それ以外の理由の場合) のどちらかに設定されるはずです。 パラメーターの値が見つからない場合は、読み取ることができなかった各パラメーターの名前に `field` が設定された要素が `fields` 配列に入ることになります。 `value` パラメーターは省略されます。 応答コード・パラメーターが `200` に設定されるためには、`field` と `value` の両方が指定されていなければなりません (`value` は、`field` パラメーターの値で識別される属性の現行値)。

要求の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/observe
{
    "d": {
        "fields": [
				{
                "field": "field_name"
            }
        ]
    },
    "reqId": "string"
}
```

応答の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/response
{
    "rc": number,
    "message": "string",
    "d": {
        "fields": [
				{
                "field": "field_name",
                "value": "field_value"
            }
        ]
    },
    "reqId": "string"
}
```


## 「属性の監視のキャンセル」要求
{: #observations-cancel}

{{site.data.keyword.iot_short_notm}} は、「属性の監視のキャンセル」要求タイプを使用して、1 つ以上のデバイス属性の現在の監視を取り消す要求をデバイスに送信できます。 要求の `fields` 部は、デバイス・モデルのデバイス属性名 (例えば、`location`、`mgmt.firmware`、または `mgmt.firmware.state` パラメーター) の配列です。

`rc` パラメーターの値が `200` でない場合は、`message` パラメーターを指定できます。

**重要:** デバイスは、[ファームウェア・アクション - 更新](requests.html#firmware-actions-update)要求タイプをサポートするためには、監視操作、通知操作、取り消し操作を実装する必要があります。

### 「属性の監視のキャンセル」要求のトピック


サーバーは、「属性の監視のキャンセル」要求を次のトピックにパブリッシュします。

```
iotdm-1/cancel
```


### 「属性の監視のキャンセル」要求のメッセージ形式


要求の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/cancel
{
    "d": {
        "fields": [
				{
                "field": "field_name"
            }
        ]
    },
    "reqId": "string"
}
```

応答の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/response
{
    "rc": number,
    "message": "string",
    "reqId": "string"
}
```



## 「属性変更の通知」要求
{: #observations-notify}

{{site.data.keyword.iot_short_notm}} は、「属性変更の通知」要求タイプを使用して、特定の属性または値のセットの監視要求を行えます。 特定の属性の値が変わったら、デバイスは最新の値を含む通知を送信する必要があります。

`field` パラメーターの値は、変化した属性の名前であり、`value` はその属性の現行値です。 属性は複合フィールドで指定できます。 単一操作の結果として複合フィールド内の複数の値が更新された場合には、通知メッセージが 1 つだけ送信されます。

**重要:** デバイスは、[ファームウェア・アクション - 更新](requests.html#firmware-actions-update)要求タイプをサポートするためには、監視操作、通知操作、取り消し操作を実装する必要があります。


### 「属性変更の通知」要求のトピック


デバイスは、「属性変更の通知」要求を次のトピックにパブリッシュします。

```
iotdevice-1/notify
```


### 「属性変更の通知」要求のメッセージ形式


要求の形式:

```
デバイスからの出力メッセージ:

Topic: iotdevice-1/notify
{
    "d": {
        "fields": [
				{
                "field": "field_name",
                "value": "field_value"
            }
        ]
    }
    "reqId": "string"
}
```

応答の形式:

```
サーバーからの着信メッセージ:

Topic: iotdm-1/response
{
    "rc": number,
    "reqId": "string"
}
```

### 「属性変更の通知」要求の応答コード

|応答コード |メッセージ |
|:---|:---|
|200   |操作は正常に終了しました。|
|400   |入力メッセージが予期される形式に一致しないか、値の 1 つが有効範囲外です。|
|404   |デバイスが {{site.data.keyword.iot_short_notm}} に登録されていません。|
|409   |競合のためにリソースを更新できませんでした (例えば、2 つの同時要求によってリソースが更新されている場合など)。 更新は後で再試行できます。|
|500   |内部エラーが発生しました。|
